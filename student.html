<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Panel</title>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;700&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="CSS/stuff.css">
    <link rel="stylesheet" href="CSS/pages.css">
    <script defer src="JS/mobile-nav.js"></script>
</head>
<body>
    <!-- Main Navbar -->
    <nav class="navbar">
        <div class="nav-header">
            <span class="luis">Student Panel</span>
            <span class="qr">QR Attendance System</span>
        </div>
        <button class="hamburger" id="hamburger">
            <div class="bar"></div>
            <div class="bar"></div>
            <div class="bar"></div>
        </button>
        <div class="create-container">
            <button class="create-button" id="logout-btn">Logout</button>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Student Dashboard -->
        <div class="student-dashboard">
            <!-- Header -->
            <div class="dashboard-header">
                <h1>Current Student Attendance</h1>
            </div>

            <!-- Main Info Grid -->
            <div class="info-grid">
                <!-- Status & QR Card (Left) -->
                <div class="info-card status-qr-card">
                    <!-- Status Section -->
                    <div class="status-section">
                        <h3>Current Status</h3>
                        <div id="status-badge" class="status-badge checked-out">Checked Out</div>
                        <div id="status-time" class="status-time">No records today</div>
                    </div>

                    <!-- QR Code Section -->
                    <div class="qr-section">
                        <h3>Your QR Code</h3>
                        <div class="qr-code-container">
                            <img id="qr-code-image" src="" alt="QR Code" style="display: none; width: 100%; max-width: 220px;">
                            <div id="qr-loading" class="qr-loading">Loading QR Code...</div>
                        </div>
                        <button class="download-btn" id="download-btn">â¬‡ Download QR Code</button>
                    </div>
                </div>

                <!-- Student Info Card (Right) -->
                <div class="info-card student-info-card">
                    <h3>Student Information</h3>
                    <div class="info-field">
                        <label>Full Name</label>
                        <div id="student-name" class="info-value">Loading...</div>
                    </div>
                    <div class="info-field">
                        <label>Email</label>
                        <div id="student-email" class="info-value">Loading...</div>
                    </div>
                    <div class="info-field">
                        <label>Section</label>
                        <div id="student-section" class="info-value">Loading...</div>
                    </div>
                    <div class="info-field">
                        <label>Student ID</label>
                        <div id="student-id" class="info-value">Loading...</div>
                    </div>
                    <div class="info-field">
                        <label>Joined</label>
                        <div id="student-joined" class="info-value">Loading...</div>
                    </div>
                </div>
            </div>

            <!-- Attendance History -->
            <div class="attendance-history-card">
                <h3>Today's Attendance Records</h3>
                <ul class="attendance-list" id="attendance-list">
                    <li class="no-attendance">No attendance records for today</li>
                </ul>
            </div>
        </div>
    </div>

    <script>
        let studentId = null;
        let studentData = null;

        // Get student info from session and fetch complete data from DB
        async function getStudentInfo() {
            try {
                const response = await fetch('/api/student/current');
                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        studentId = result.student_id;
                        studentData = result.student;
                        return studentId;
                    } else {
                        console.error('API error:', result.error);
                        showError(result.error || 'Failed to load student information');
                    }
                } else if (response.status === 401) {
                    showError('Session expired. Please log in again.');
                    setTimeout(() => window.location.href = '/', 2000);
                } else {
                    showError('Failed to load student information');
                }
            } catch (error) {
                console.error('Error getting student info:', error);
                showError('Network error: Could not reach server');
            }
            return null;
        }

        // Display student information from database
        function displayStudentInfo() {
            if (!studentData) {
                document.getElementById('student-name').textContent = 'Error loading name';
                document.getElementById('student-email').textContent = 'Error loading email';
                document.getElementById('student-section').textContent = 'N/A';
                document.getElementById('student-id').textContent = studentId || 'N/A';
                document.getElementById('student-joined').textContent = 'Error loading date';
                return;
            }

            // Display all student information
            document.getElementById('student-name').textContent = studentData.full_name || 'N/A';
            document.getElementById('student-email').textContent = studentData.email || 'N/A';
            document.getElementById('student-section').textContent = studentData.section || 'Not assigned';
            document.getElementById('student-id').textContent = `#${studentId}`;
            
            // Format and display joined date
            if (studentData.created_at) {
                try {
                    const joinDate = new Date(studentData.created_at);
                    document.getElementById('student-joined').textContent = joinDate.toLocaleDateString('en-US', {
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric'
                    });
                } catch (e) {
                    document.getElementById('student-joined').textContent = 'N/A';
                }
            } else {
                document.getElementById('student-joined').textContent = 'N/A';
            }
        }

        // Show error message to user
        function showError(message) {
            console.error(message);
            const errorDiv = document.createElement('div');
            errorDiv.style.cssText = 'background: #f44336; color: white; padding: 15px; border-radius: 8px; margin: 15px; text-align: center; font-weight: bold;';
            errorDiv.textContent = message;
            document.querySelector('.student-dashboard').insertBefore(errorDiv, document.querySelector('.dashboard-header'));
        }

        // Load QR Code
        async function loadQRCode() {
            try {
                if (!studentId) {
                    document.getElementById('qr-loading').textContent = 'Error: Student ID not found';
                    return;
                }

                const response = await fetch('/api/student/qr-image');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const result = await response.json();
                
                if (result.success && result.qr_image) {
                    const qrImg = document.getElementById('qr-code-image');
                    qrImg.src = result.qr_image;
                    qrImg.style.display = 'block';
                    document.getElementById('qr-loading').style.display = 'none';
                } else {
                    document.getElementById('qr-loading').textContent = 'QR code not generated yet';
                }
            } catch (error) {
                console.error('Error loading QR code:', error);
                document.getElementById('qr-loading').textContent = 'Failed to load QR code';
            }
        }

        // Download QR Code
        document.getElementById('download-btn').addEventListener('click', async () => {
            if (!studentId) {
                alert('Error: Student ID not found');
                return;
            }
            
            try {
                window.location.href = '/api/student/qr-code';
            } catch (error) {
                console.error('Error downloading QR code:', error);
                alert('Failed to download QR code');
            }
        });

        // Load Status and Attendance
        async function loadStatus() {
            try {
                if (!studentId) return;

                const response = await fetch('/api/student/status');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const result = await response.json();
                
                if (result.success) {
                    const statusBadge = document.getElementById('status-badge');
                    const statusTime = document.getElementById('status-time');
                    const attendanceList = document.getElementById('attendance-list');

                    // Show teacher-set attendance status (PRESENT/ABSENT/LATE/CUTTING/EXCUSED)
                    const attendanceStatus = result.attendance_status || (result.checked_state === 'checked_in' ? 'PRESENT' : 'ABSENT');
                    statusBadge.textContent = attendanceStatus.replace('_', ' ');
                    // Add a CSS class to reflect checked-in vs checked-out for visual cue
                    if (result.checked_state === 'checked_in') {
                        statusBadge.className = 'status-badge checked-in';
                    } else {
                        statusBadge.className = 'status-badge checked-out';
                    }

                    // Update status time (show Philippine time)
                    if (result.last_record && result.last_record.timestamp) {
                        const time = new Date(result.last_record.timestamp);
                        const statusText = (result.last_record.status || '').replace('_', ' ');
                        statusTime.textContent = `Last ${statusText}: ${time.toLocaleString('en-PH', { timeZone: 'Asia/Manila' })}`;
                    } else {
                        statusTime.textContent = 'No records today';
                    }
                    
                    // Update attendance history
                    if (result.today_attendance && result.today_attendance.length > 0) {
                        attendanceList.innerHTML = '';
                        result.today_attendance.forEach(record => {
                            const li = document.createElement('li');
                            li.className = 'attendance-item';
                            const time = new Date(record.timestamp);
                            const status = record.status.replace('_', ' ').toUpperCase();
                            const statusClass = record.status === 'check_in' ? 'check-in' : 'check-out';
                            li.innerHTML = `
                                <span class="time">${time.toLocaleString('en-PH', { timeZone: 'Asia/Manila' })}</span>
                                <span class="status ${statusClass}">${status}</span>
                            `;
                            attendanceList.appendChild(li);
                        });
                    } else {
                        attendanceList.innerHTML = '<li class="no-attendance">No attendance records for today</li>';
                    }
                } else {
                    console.error('Failed to load status:', result.error);
                }
            } catch (error) {
                console.error('Error loading status:', error);
                // Don't show error to user, just log it
            }
        }

        // Logout
        document.getElementById('logout-btn').addEventListener('click', async () => {
            try {
                const response = await fetch('/api/logout', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                const result = await response.json();
                if (result.success) {
                    window.location.href = result.redirect || '/';
                }
            } catch (error) {
                console.error('Logout error:', error);
                window.location.href = '/';
            }
        });

        // Initialize dashboard
        async function init() {
            try {
                // Get student ID and data from API
                studentId = await getStudentInfo();
                
                if (!studentId) {
                    showError('Error: Could not load student information. Please try logging in again.');
                    setTimeout(() => window.location.href = '/', 3000);
                    return;
                }
                
                // Display the student information on the dashboard
                displayStudentInfo();
                
                // Load QR code and status in parallel
                await Promise.all([
                    loadQRCode(),
                    loadStatus()
                ]);
                
                // Refresh status every 30 seconds
                setInterval(loadStatus, 30000);
            } catch (error) {
                console.error('Initialization error:', error);
                showError('Failed to initialize dashboard');
            }
        }

        // Start initialization when page loads
        init();
    </script>
</body>
</html>

